<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Blockchain Pulse</title>

<style>
/* ---------- BASE ---------- */
body {
  background: #050505;
  color: #fff;
  font-family: Inter, system-ui, -apple-system, sans-serif;
  margin: 0;
  padding: 10px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  box-sizing: border-box;
  overflow: hidden;
}

h1 { margin: 0 0 5px; font-size: 1.5rem; }
p { margin: 0 0 15px; font-size: 0.9rem; color: #666; }

/* ---------- GRID ---------- */
.grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  width: 100%;
  
  /* Keeps the 3x3 grid fitted within the screen height */
  max-width: 78vh; 
  aspect-ratio: 1 / 1;
}

/* ---------- CARD ---------- */
.card {
  background: #111;
  border: 1px solid #333;
  border-radius: 8px;
  overflow: hidden;
  display: flex;
  flex-direction: column; /* Stacks Header -> Canvas */
  position: relative;
}

/* ---------- HEADER ---------- */
.label {
  padding: 6px 10px;
  border-bottom: 1px solid #333;
  background: #111; /* Solid background */
  
  /* FIX: Relative positioning so it pushes the canvas down */
  position: relative;
  flex-shrink: 0; /* Ensures header doesn't get squashed */
  z-index: 2;
}

.chain {
  color: #00ff88;
  font-weight: 700;
  font-size: 12px;
  margin-bottom: 2px;
}

.stats {
  display: flex;
  justify-content: space-between;
  font-size: 9px;
  font-family: monospace;
  color: #888;
}

.val { color: #fff }

/* ---------- CANVAS ---------- */
canvas {
  width: 100%;
  /* FIX: Flex grow fills the remaining space below the header */
  flex-grow: 1; 
  height: 0; /* Required for flex-grow to calculate properly in some browsers */
  background: #000;
  image-rendering: pixelated;
  display: block;
}

/* ---------- BUTTON ---------- */
button {
  margin-top: 15px;
  background: #00ff88;
  color: #000;
  border: none;
  padding: 10px 34px;
  font-size: 14px;
  font-weight: 800;
  border-radius: 6px;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 1px;
}

button:hover {
  background: #00cc6a;
}
</style>
</head>

<body>

  <div>
    <center>
      <h1>Live Blockchain Pulse</h1>
      <p>Explorer-stable real-time visualization</p>
    </center>
  </div>

  <div class="grid" id="grid"></div>

  <button id="startBtn">SYNC & START</button>

<script>
const CHAINS = [
  {name:"Fogo",endpoint:"/api/fogo-stats",img:"fogo.png"},
  {name:"Aptos",endpoint:"/api/aptos-stats",img:"aptos.png"},
  {name:"Sui",endpoint:"/api/sui-stats",img:"sui.png"},
  {name:"Solana",endpoint:"/api/solana-stats",img:"solana.png"},
  {name:"Op BNB",endpoint:"/api/bnb-stats",img:"opbnb.png"},
  {name:"Sei",endpoint:"/api/sei-stats",img:"sei.png"},
  {name:"Monad",endpoint:"/api/monad-stats",img:"monad.png"},
  {name:"Somnia",endpoint:"/api/somnia-stats",img:"somnia.png"},
  {name:"Arbitrum",endpoint:"/api/arbitrum-stats",img:"arbitrum.png"}
];

const TOTAL_PIXELS = 400*400;
const state = {};
let started = false;

/* ---------- SETUP ---------- */
const grid = document.getElementById("grid");
CHAINS.forEach(c=>{
  state[c.name]={
    lastHeight:0,lastHeightTime:0,
    lastTx:0,lastTxTime:0,
    blockMs:null,
    tpsSamples:[],
    tps:"Syncing",
    running:false,
    img:null,ctx:null
  };

  const el=document.createElement("div");
  el.className="card";
  el.innerHTML=`
    <div class="label">
      <div class="chain">${c.name}</div>
      <div class="stats">
        <span>SPEED: <span class="val" id="spd-${c.name}">Syncing</span></span>
        <span>TPS: <span class="val" id="tps-${c.name}">Syncing</span></span>
      </div>
    </div>
    <canvas id="cv-${c.name}"></canvas>`;
  grid.appendChild(el);

  const cv=el.querySelector("canvas");
  const ctx=cv.getContext("2d");
  
  // Internal resolution stays high for crisp pixels
  cv.width=400; 
  cv.height=400;

  const img=new Image();
  img.src=c.img;
  img.onload=()=>{
    ctx.drawImage(img,0,0,400,400);
    state[c.name].img=ctx.getImageData(0,0,400,400);
    ctx.fillStyle="black";
    ctx.fillRect(0,0,400,400);
    state[c.name].ctx=ctx;
  };

  setInterval(()=>poll(c),1500);
});

/* ---------- POLLING ---------- */
async function poll(chain){
  try{
    const r=await fetch(chain.endpoint);
    const d=await r.json();
    const s=state[chain.name];
    const now=Date.now();

    const h=d.height||d.tx_count||0;
    if(s.lastHeight && h>s.lastHeight){
      const raw=(now-s.lastHeightTime)/(h-s.lastHeight);
      s.blockMs = s.blockMs ? s.blockMs*0.8 + raw*0.2 : raw;
    }
    s.lastHeight=h;
    s.lastHeightTime=now;

    if(d.tps!==undefined){
      s.tps=d.tps.toFixed(2);
    }else if(s.lastTx && d.tx_count>s.lastTx){
      const sec=(now-s.lastTxTime)/1000;
      const instant=(d.tx_count-s.lastTx)/sec;
      s.tpsSamples.push(instant);
      if(s.tpsSamples.length>10) s.tpsSamples.shift();
      s.tps=(s.tpsSamples.reduce((a,b)=>a+b,0)/s.tpsSamples.length).toFixed(2);
    }

    s.lastTx=d.tx_count||s.lastTx;
    s.lastTxTime=now;

    document.getElementById(`tps-${chain.name}`).innerText=s.tps;
    document.getElementById(`spd-${chain.name}`).innerText=
      s.blockMs ? (s.blockMs/1000).toFixed(2)+"s" : "Syncing";

  }catch(e){ console.warn(chain.name,e) }
}

/* ---------- ANIMATION ---------- */
function startReveal(chain){
  const s=state[chain.name];
  if(s.running||!s.img) return;
  s.running=true;

  const px=[...Array(TOTAL_PIXELS).keys()];
  for(let i=px.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [px[i],px[j]]=[px[j],px[i]];
  }

  let i=0,last=performance.now();

  function frame(now){
    const dt=(now-last)/1000;
    last=now;
    if(!started||!s.blockMs) return requestAnimationFrame(frame);

    const rate=TOTAL_PIXELS/s.blockMs;
    const count=Math.max(1,Math.floor(rate*dt));

    for(let n=0;n<count;n++){
      const p=px[i++]; if(p===undefined) return;
      const x=p%400,y=(p/400)|0;
      const d=s.img.data,j=p*4;
      s.ctx.fillStyle=`rgb(${d[j]},${d[j+1]},${d[j+2]})`;
      s.ctx.fillRect(x,y,1,1);
    }
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

/* ---------- START ---------- */
document.getElementById("startBtn").onclick=()=>{
  started=true;
  CHAINS.forEach(startReveal);
};
</script>

</body>
</html>