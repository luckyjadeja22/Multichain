const express = require('express');
const axios = require('axios');
const app = express();
const PORT = 3000;

app.use(express.static('public'));

// Helper: Basic JSON RPC POST
const getStats = async (url, body) => {
    try {
        const response = await axios.post(url, body, { timeout: 5000 });
        return response.data.result;
    } catch (e) { return null; }
};

// Helper: Accurate TPS for EVM chains (Arbitrum, BNB, Sei, Monad, Somnia)
async function getEvmStats(rpcUrl, lookbackCount) {
    try {
        const latestHex = await getStats(rpcUrl, { jsonrpc: "2.0", id: 1, method: "eth_blockNumber", params: [] });
        if (!latestHex) return { tps: 0, height: 0, timestamp: Date.now() };
        
        const latestHeight = parseInt(latestHex, 16);
        const promises = [];
        
        // Fetch last N blocks
        for (let i = 0; i < lookbackCount; i++) {
            const blockNumHex = "0x" + (latestHeight - i).toString(16);
            promises.push(getStats(rpcUrl, { jsonrpc: "2.0", id: 1, method: "eth_getBlockByNumber", params: [blockNumHex, false] }));
        }

        const blocks = await Promise.all(promises);
        let totalTx = 0;
        let newestTime = 0;
        let oldestTime = 0;

        blocks.filter(b => b && b.timestamp).forEach((b) => {
            const t = parseInt(b.timestamp, 16);
            totalTx += b.transactions.length;
            if (t > newestTime) newestTime = t;
            if (oldestTime === 0 || t < oldestTime) oldestTime = t;
        });

        // Avoid division by zero
        const timeDiff = newestTime - oldestTime;
        const calculatedTps = (timeDiff > 0) ? (totalTx / timeDiff) : (totalTx); // Fallback if 1 block

        return {
            tps: calculatedTps, 
            height: latestHeight,
            timestamp: newestTime * 1000
        };
    } catch (e) { 
        return { tps: 0, height: 0, timestamp: Date.now() }; 
    }
}

// --- API ROUTES ---

// 1. Aptos
app.get('/api/aptos-stats', async (req, res) => {
    try {
        const r = await axios.get('https://api.mainnet.aptoslabs.com/v1/');
        res.json({ tx_count: parseInt(r.data.ledger_version), height: parseInt(r.data.block_height), timestamp: parseInt(r.data.ledger_timestamp) / 1000 });
    } catch (e) { res.status(500).send(); }
});

// 2. Sui
app.get('/api/sui-stats', async (req, res) => {
    try {
        const SUI = 'https://fullnode.mainnet.sui.io:443';
        const seq = await getStats(SUI, { jsonrpc: "2.0", id: 1, method: "sui_getLatestCheckpointSequenceNumber" });
        const det = await getStats(SUI, { jsonrpc: "2.0", id: 1, method: "sui_getCheckpoint", params: [seq] });
        res.json({ tx_count: parseInt(det.networkTotalTransactions), height: parseInt(det.sequenceNumber), timestamp: parseInt(det.timestampMs) });
    } catch (e) { res.status(500).send(); }
});

// 3. Solana
app.get('/api/solana-stats', async (req, res) => {
    try {
        const SOL = 'https://api.mainnet-beta.solana.com';
        const h = await getStats(SOL, { jsonrpc: "2.0", id: 1, method: "getSlot" });
        const tx = await getStats(SOL, { jsonrpc: "2.0", id: 1, method: "getTransactionCount" });
        res.json({ tx_count: tx, height: h, timestamp: Date.now() });
    } catch (e) { res.status(500).send(); }
});

// 4. Fogo (SVM Chain - Uses Solana Logic)
app.get('/api/fogo-stats', async (req, res) => {
    try {
        const FOGO_RPC = 'https://mainnet.fogo.io'; 
        const h = await getStats(FOGO_RPC, { jsonrpc: "2.0", id: 1, method: "getSlot" });
        const tx = await getStats(FOGO_RPC, { jsonrpc: "2.0", id: 1, method: "getTransactionCount" });
        res.json({ tx_count: tx || 0, height: h || 0, timestamp: Date.now() });
    } catch (e) { res.status(500).send(); }
});

// 5. Monad (EVM Chain)
app.get('/api/monad-stats', async (req, res) => {
    const stats = await getEvmStats('https://rpc.monad.xyz', 5);
    res.json(stats);
});

// 6. Somnia (EVM Chain) - REPLACED NEAR
app.get('/api/somnia-stats', async (req, res) => {
    const stats = await getEvmStats('https://somnia.publicnode.com', 10);
    res.json(stats);
});

// EVM Chains
app.get('/api/bnb-stats', async (req, res) => {
    const stats = await getEvmStats('https://bsc-dataseed.binance.org/', 5);
    res.json(stats);
});

app.get('/api/arbitrum-stats', async (req, res) => {
    const stats = await getEvmStats('https://arb1.arbitrum.io/rpc', 10);
    res.json(stats);
});

app.get('/api/sei-stats', async (req, res) => {
    const stats = await getEvmStats('https://evm-rpc.sei-apis.com', 10);
    res.json(stats);
});

app.listen(PORT, () => console.log(`Server running on http://localhost:${PORT}`));